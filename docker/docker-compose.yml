# docker/docker-compose.yml (Phase 3: DB + API + Dashboard)

services:
  # 1. 詐欺偵測 API 服務 (保持不變)
  fraud_api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: fraud-api
    ports:
      - "8000:8000"
    restart: always
    environment:
      # 將 DB 連線資訊傳遞給 API (雖然 API 暫時不用，但這是好習慣)
      DB_HOST: postgres_db
      DB_NAME: fraud_db
      DB_USER: user
      DB_PASSWORD: password

  # 2. Streamlit Dashboard 服務 (保持不變)
  fraud_dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    container_name: fraud-dashboard
    ports:
      - "8501:8501"
    depends_on:
      - fraud_api
    restart: always

  # 3. PostgreSQL 資料庫服務
  postgres_db:
    image: postgres:16-alpine
    container_name: postgres_db
    environment:
      # 設定資料庫名稱、使用者和密碼
      POSTGRES_DB: fraud_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      # 確保資料庫資料持久化
      - postgres_data:/var/lib/postgresql/data
    ports:
      # 將資料庫埠號映射到主機，方便 Adminer 連線
      - "5432:5432"
    restart: always

  # 4. Adminer (輕量級資料庫管理介面)
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    ports:
      # 管理介面埠號
      - "8080:8080"
    depends_on:
      - postgres_db # 確保 DB 啟動後才啟動管理介面
    restart: always

  # 5. MLflow 追蹤服務
  mlflow_server:
    image: python:3.12-slim # 使用 python 基礎映像檔，將在下一步構建
    container_name: mlflow_server
    build:
      context: ..
      dockerfile: docker/Dockerfile.mlflow # 這是我們下一步要建立的
    ports:
      - "5000:5000" # MLflow 預設埠號
    environment:
      # 將 MLflow 後端儲存設定為我們現有的 Postgres DB
      MLFLOW_TRACKING_URI: postgresql://user:password@postgres_db:5432/fraud_db
      # MLflow 儲存模型的路徑 (在容器內)
      MLFLOW_ARTIFACT_URI: file:/mlflow/artifacts
    volumes:
      # 儲存 MLflow 的人工製品 (模型檔案、圖片等)
      - mlflow_artifacts:/mlflow/artifacts
    depends_on:
      - postgres_db # 確保 DB 啟動後 MLflow 才能連線
    restart: always


# 定義 Volumes 以持久化資料庫數據
volumes:
  postgres_data:
  mlflow_artifacts: