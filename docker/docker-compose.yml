# version: '3.8'  # 註解掉，Docker Compose 現在不需要版本號

services:
  # 1. PostgreSQL 資料庫服務 (基礎服務，所有服務都依賴它)
  postgres_db:
    image: postgres:16-alpine
    container_name: postgres_db
    environment:
      POSTGRES_DB: fraud_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d fraud_db"] # 讓其他服務知道 DB 何時準備好
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Adminer (資料庫管理介面)
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    # 修正端口，避免與 Airflow 衝突
    ports:
      - "8088:8080" 
    depends_on:
      - postgres_db
    restart: always

  # 3. MLflow 追蹤服務
  mlflow_server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mlflow
    container_name: mlflow_server
    ports:
      - "5000:5000"
    environment:
      # 使用檔案系統儲存以避免資料庫遷移問題
      - BACKEND_STORE_URI=file:///mlflow/mlruns
      - DEFAULT_ARTIFACT_ROOT=/mlflow/artifacts
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
      - mlflow_runs:/mlflow/mlruns
    restart: always

  # --- Airflow 核心服務區塊 ---
  
  # 4. Airflow 初始化 (一次性任務：創建 DB Schema 和 Admin 用戶)
  airflow-init:
    build: 
      context: ..
      dockerfile: docker/Dockerfile.airflow
    container_name: airflow_init
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://user:password@postgres_db:5432/fraud_db
      _PIP_ADDITIONAL_REQUIREMENTS: 'psycopg2-binary'
    # 執行 DB 遷移和用戶創建
    command: >
      bash -c "airflow db migrate && 
               airflow users create --username admin --firstname admin --lastname user --role Admin --email admin@example.com --password admin"
    depends_on:
      postgres_db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exit 0"] # 執行完畢即視為健康

  # 5. Airflow Webserver (UI 介面)
  airflow-webserver:
    build:
      context: ..
      dockerfile: docker/Dockerfile.airflow
    container_name: airflow_webserver
    restart: always
    ports:
      - "8080:8080" # Airflow UI 
    volumes:
      # 掛載 DAGs、Python 腳本和資料檔案
      - ../dags:/opt/airflow/dags
      - ../src:/opt/airflow/src
      - ../data:/opt/airflow/data 
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://user:password@postgres_db:5432/fraud_db
      _PIP_ADDITIONAL_REQUIREMENTS: 'psycopg2-binary'
      # ✅ 使用正確格式的 Fernet key  
      AIRFLOW__CORE__FERNET_KEY: 'CpWSlmgJ8NxyV2V09CcrS703tlhA_wVyNz54ykpUSpU=' 
      AIRFLOW__WEBSERVER__SECRET_KEY: 'CpWSlmgJ8NxyV2V09CcrS703tlhA_wVyNz54ykpUSpU='
      # 修正日誌權限問題
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'false'
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'
      AIRFLOW__WEBSERVER__RBAC: 'false'
    command: webserver
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  # 6. Airflow 排程器 (Scheduler)
  airflow-scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.airflow
    container_name: airflow_scheduler
    restart: always
    volumes:
      - ../dags:/opt/airflow/dags
      - ../src:/opt/airflow/src 
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://user:password@postgres_db:5432/fraud_db
      _PIP_ADDITIONAL_REQUIREMENTS: 'psycopg2-binary'
      AIRFLOW__CORE__FERNET_KEY: 'CpWSlmgJ8NxyV2V09CcrS703tlhA_wVyNz54ykpUSpU='
    command: scheduler
    depends_on:
      airflow-init:
        condition: service_completed_successfully
      
  # 7. 詐欺偵測 API 服務
  fraud_api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: fraud-api
    ports:
      - "8000:8000"
    restart: always
    environment:
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      DB_HOST: postgres_db
      DB_NAME: fraud_db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      - mlflow_server # API 依賴 MLflow Server 運行

  # 8. Streamlit Dashboard 服務
  fraud_dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    container_name: fraud-dashboard
    ports:
      - "8501:8501"
    depends_on:
      - fraud_api
      - mlflow_server
    restart: always
    environment:
      MLFLOW_BASE_URI: http://mlflow_server:5000/api/2.0/
      API_URL: http://fraud_api:8000/predict

volumes:
  postgres_data:
  mlflow_artifacts:
  mlflow_runs:
