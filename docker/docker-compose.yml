# docker/docker-compose.yml

services:
  # 1. 詐欺偵測 API 服務 (保持不變)
  fraud_api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: fraud-api
    ports:
      - "8000:8000"
    restart: always
    environment:
      # --- 新增：讓 API 也知道 MLflow Server 在哪 ---
      MLFLOW_TRACKING_URI: http://mlflow_server:5000
      DB_HOST: postgres_db
      DB_NAME: fraud_db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      - mlflow_server

  # 2. Streamlit Dashboard 服務
  fraud_dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dashboard
    container_name: fraud-dashboard
    ports:
      - "8501:8501"
    depends_on:
      - fraud_api
      - mlflow_server
    restart: always
    environment:
      # --- 新增：讓 Dashboard 也知道 MLflow Server 在哪 ---
      MLFLOW_BASE_URI: http://mlflow_server:5000/api/2.0/
      API_URL: http://fraud_api:8000/predict

  # 3. PostgreSQL 資料庫服務 (保持不變)
  postgres_db:
    image: postgres:16-alpine
    container_name: postgres_db
    environment:
      POSTGRES_DB: fraud_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d fraud_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 4. Adminer (保持不變)
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    ports:
      - "8080:8080"
    depends_on:
      - postgres_db
    restart: always

  # 5. MLflow 追蹤服務
  mlflow_server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mlflow
    container_name: mlflow_server
    ports:
      - "5000:5000"
    environment:
      MLFLOW_TRACKING_URI: postgresql://user:password@postgres_db:5432/fraud_db
      MLFLOW_ARTIFACT_URI: file:/mlflow/artifacts
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
    depends_on:
      postgres_db:
        condition: service_healthy
    restart: always

  # --- 新增：6. 用於載入原始數據的服務 ---
  data_loader:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: data_loader
    command: ["python", "src/etl/db_load.py"]
    depends_on:
      postgres_db:
        condition: service_healthy
    environment:
      DB_HOST: postgres_db
      DB_NAME: fraud_db
      DB_USER: user
      DB_PASSWORD: password

  # --- 新增：7. 用於執行一次性 ETL/訓練任務的服務 ---
  etl_runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api # 可以重用 API 的環境
    container_name: etl_runner
    command: ["python", "src/etl/transform_data.py"] # 指定容器啟動時要執行的指令
    depends_on:
      mlflow_server:
        condition: service_started
      postgres_db:
        condition: service_healthy
    environment:
      # 關鍵：將 Docker 網路中的服務名稱傳遞給 Python 腳本
      DB_HOST: postgres_db
      MLFLOW_HOST: mlflow_server
      DB_NAME: fraud_db
      DB_USER: user
      DB_PASSWORD: password
    # 這個服務執行完就會停止，所以不需要 ports 和 restart policy

volumes:
  postgres_data:
  mlflow_artifacts:
